﻿@{
    ViewBag.Title = "Hủy Booking";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Xác nhận hủy Booking</h4>
            </div>

            <div id="loading_spinner" class="text-center p-5">
                <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-2 text-muted">Đang kiểm tra chính sách hủy...</p>
            </div>

            <div class="card-body" id="cancel_content" style="display:none;">

                <div class="alert alert-warning border-warning">
                    <h5 class="alert-heading"><i class="fas fa-info-circle"></i> Thông tin booking</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Mã:</strong> <span id="lbl_Code" class="badge bg-dark"></span></p>
                            <p class="mb-1"><strong>Khách sạn:</strong> <span id="lbl_HotelName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Tổng tiền:</strong> <span id="lbl_TotalAmount" class="fw-bold text-danger"></span></p>
                            <p class="mb-0"><small>Hạn hủy miễn phí: <span id="lbl_Deadline" class="fw-bold"></span></small></p>
                        </div>
                    </div>
                </div>

                <div id="div_PolicyAlert">
                </div>

                <hr />

                <form id="cancelForm">
                    <div class="form-group mb-3">
                        <label for="cancelReason" class="form-label fw-bold">Lý do hủy (Không bắt buộc):</label>
                        <textarea class="form-control" id="cancelReason" rows="3" placeholder="Ví dụ: Thay đổi lịch trình, tìm được khách sạn khác..."></textarea>
                    </div>

                    <div class="form-check mb-4 p-3 bg-light border rounded">
                        <input class="form-check-input" type="checkbox" id="confirmCancel" style="transform: scale(1.2); margin-right: 10px;" required>
                        <label class="form-check-label fw-bold text-danger" for="confirmCancel">
                            Tôi đã đọc kỹ chính sách và đồng ý hủy booking này.
                        </label>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button type="submit" class="btn btn-danger btn-lg px-5" id="btn_SubmitCancel">
                            <i class="fas fa-times-circle"></i> Xác nhận hủy ngay
                        </button>
                        <a href="javascript:history.back()" class="btn btn-secondary btn-lg px-5">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var url_domain = window.location.origin;
        // Lấy ID từ URL (Ví dụ: /Cancel/5 -> lấy số 5)
        var bookingId = window.location.pathname.split('/').pop();

        // Biến toàn cục lưu trạng thái
        var currentBookingData = null;
        var isFreeCancellation = false;

        $(document).ready(function () {
            // Kiểm tra nếu ID không hợp lệ
            if (!bookingId || isNaN(bookingId)) {
                alert("Đường dẫn không hợp lệ!");
                window.location.href = "/Customer/Booking/Index";
                return;
            }

            loadBookingInfo();

            // Xử lý sự kiện submit
            $("#cancelForm").submit(function (e) {
                e.preventDefault();
                submitCancel();
            });
        });

        function loadBookingInfo() {
            $.ajax({
                type: "GET",
                url: url_domain + '/Customer/Booking/GetBookingInfo',
                data: { id: bookingId },
                success: function (response) {
                    if (response.success) {
                        currentBookingData = response.data;
                        renderUI(response.data);
                        $("#loading_spinner").fadeOut(200, function () {
                            $("#cancel_content").fadeIn();
                        });
                    } else {
                        alert("Không tìm thấy thông tin booking.");
                        window.location.href = "/Customer/Booking/Index";
                    }
                },
                error: function () {
                    alert("Lỗi kết nối đến máy chủ.");
                }
            });
        }

        function renderUI(data) {
            // 1. Điền thông tin cơ bản
            $("#lbl_Code").text(data.Code);
            $("#lbl_HotelName").text(data.HotelName);
            $("#lbl_TotalAmount").text(formatCurrency(data.TotalAmount));

            // 2. Xử lý logic ngày tháng & Phí hủy
            var deadlineDate = parseJsonDate(data.FreeCancellationDeadline);
            $("#lbl_Deadline").text(formatDateTime(deadlineDate));

            var now = new Date();
            isFreeCancellation = now < deadlineDate; // So sánh thời gian thực

            var htmlAlert = "";

            if (isFreeCancellation) {
                // Trường hợp MIỄN PHÍ
                htmlAlert = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle"></i> Bạn được hủy miễn phí!</h5>
                            <p class="mb-0">Bạn đang trong thời hạn cho phép. Số tiền <strong>${formatCurrency(data.TotalAmount)}</strong> sẽ được hoàn lại đầy đủ.</p>
                        </div>`;
            } else {
                // Trường hợp CÓ PHÍ
                var penalty = data.TotalAmount * 0.5; // 50%
                var refund = data.TotalAmount - penalty;

                htmlAlert = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle"></i> Hủy quá hạn - Mất phí</h5>
                            <p>Bạn đã quá hạn hủy miễn phí. Theo chính sách, bạn sẽ chịu phí phạt <strong>50%</strong>.</p>
                            <ul class="mb-0">
                                <li>Phí phạt hủy: <strong class="text-danger">${formatCurrency(penalty)}</strong></li>
                                <li>Số tiền hoàn lại: <strong class="text-success">${formatCurrency(refund)}</strong></li>
                            </ul>
                        </div>`;
            }
            $("#div_PolicyAlert").html(htmlAlert);
        }

        function submitCancel() {
            if (!$("#confirmCancel").is(':checked')) {
                alert("Vui lòng tích vào ô xác nhận đồng ý hủy.");
                return;
            }

            var confirmMsg = isFreeCancellation
                ? "Xác nhận hủy booking này? (Bạn sẽ được hoàn tiền 100%)"
                : "CẢNH BÁO: Bạn sẽ bị trừ phí phạt 50%. Bạn có chắc chắn muốn tiếp tục?";

            if (!confirm(confirmMsg)) return;

            // Khóa nút để tránh spam
            var btn = $("#btn_SubmitCancel");
            var originalText = btn.html();
            btn.prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');

            var model = {
                BookingId: parseInt(bookingId),
                Reason: $("#cancelReason").val(),
                IsFreeCancellation: isFreeCancellation
            };

            $.ajax({
                type: "POST",
                url: url_domain + '/Customer/Booking/CancelBooking',
                data: JSON.stringify(model),
                contentType: "application/json; charset=utf-8",
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        window.location.href = url_domain + '/Customer/Booking/Index'; // Về trang danh sách
                    } else {
                        alert("Lỗi: " + response.message);
                        btn.prop("disabled", false).html(originalText);
                    }
                },
                error: function () {
                    alert("Đã xảy ra lỗi hệ thống.");
                    btn.prop("disabled", false).html(originalText);
                }
            });
        }

        // --- Helper Functions ---

        // Format tiền
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount).replace('₫', 'VNĐ');
        }

        // Parse Date từ JSON C# (/Date(123...)/)
        function parseJsonDate(jsonDate) {
            if (!jsonDate) return new Date();
            var timestamp = parseInt(jsonDate.replace(/\/Date\((-?\d+)\)\//, '$1'));
            return new Date(timestamp);
        }

        // Format Date hiển thị
        function formatDateTime(date) {
            return date.getDate().toString().padStart(2, '0') + "/" +
                (date.getMonth() + 1).toString().padStart(2, '0') + "/" +
                date.getFullYear() + " " +
                date.getHours().toString().padStart(2, '0') + ":" +
                date.getMinutes().toString().padStart(2, '0');
        }
    </script>
}
