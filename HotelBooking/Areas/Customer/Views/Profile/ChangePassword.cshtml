﻿@{
    ViewBag.Title = "Đổi mật khẩu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-key"></i> Đổi mật khẩu</h4>
            </div>
            <div class="card-body">
                <form id="changePasswordForm">
                    <div id="success-message" class="alert alert-success" style="display:none;"></div>
                    <div id="error-message" class="alert alert-danger" style="display:none;"></div>

                    <div class="form-group mb-3">
                        <label for="oldPassword">Mật khẩu cũ <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="oldPassword" required />
                    </div>

                    <div class="form-group mb-3">
                        <label for="newPassword">Mật khẩu mới <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="newPassword" minlength="6" required />
                        <small class="text-muted">Tối thiểu 6 ký tự</small>
                    </div>

                    <div class="form-group mb-3">
                        <label for="confirmPassword">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="confirmPassword" minlength="6" required />
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="fas fa-save"></i> Đổi mật khẩu
                        </button>
                        <a href="/Customer/Profile/Index" class="btn btn-secondary flex-fill">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            $("#changePasswordForm").submit(function (e) {
                e.preventDefault();

                var oldPassword = $("#oldPassword").val();
                var newPassword = $("#newPassword").val();
                var confirmPassword = $("#confirmPassword").val();

                if (newPassword !== confirmPassword) {
                    $("#error-message").text("Mật khẩu mới không khớp").show();
                    $("#success-message").hide();
                    return;
                }

                if (newPassword.length < 6) {
                    $("#error-message").text("Mật khẩu mới phải có ít nhất 6 ký tự").show();
                    $("#success-message").hide();
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: window.location.origin + '/Customer/Profile/ChangePassword',
                    data: JSON.stringify({
                        oldPassword: oldPassword,
                        newPassword: newPassword
                    }),
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        if (response.success) {
                            $("#success-message").text(response.message).show();
                            $("#error-message").hide();
                            $("#changePasswordForm")[0].reset();

                            setTimeout(function () {
                                window.location.href = '/Customer/Profile/Index';
                            }, 2000);
                        } else {
                            $("#error-message").text(response.message).show();
                            $("#success-message").hide();
                        }
                    },
                    error: function () {
                        $("#error-message").text("Đã xảy ra lỗi. Vui lòng thử lại.").show();
                        $("#success-message").hide();
                    }
                });
            });
        });
    </script>
}

