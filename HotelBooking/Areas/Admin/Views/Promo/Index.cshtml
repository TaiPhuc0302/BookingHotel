@{
    ViewBag.Title = "Quản lý Khuyến mãi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="app-content-header">
    <div class="container-fluid">
        <!-- Tiêu đề -->
        <div class="row mb-4">
            <div class="col-sm-6">
                <h3 class="mb-0">Quản lý Khuyến mãi</h3>
            </div>
        </div>

        <!-- Bộ lọc + tìm kiếm -->
        <div class="row g-3 align-items-end mb-3">
            <div class="col-md-4">
                <label class="form-label">Tìm mã / mô tả</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập từ khóa...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Loại khuyến mãi</label>
                <select id="typeFilter" class="form-select">
                    <option value="">Tất cả loại</option>
                    <option value="amount">Giảm tiền (VNĐ)</option>
                    <option value="percentage">Giảm theo %</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Trạng thái</label>
                <select id="statusFilter" class="form-select">
                    <option value="">Tất cả</option>
                    <option value="true">Đang hoạt động</option>
                    <option value="false">Tạm dừng</option>
                </select>
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button onclick="applyFilters()" class="btn btn-primary flex-grow-1">Lọc</button>
                <button onclick="resetFilters()" class="btn btn-outline-secondary">Reset</button>
            </div>
        </div>

        <!-- NÚT THÊM – ĐÚNG VỊ TRÍ BẠN MUỐN: DƯỚI BỘ LỌC, CĂN PHẢI -->
        <div class="mb-3 text-end">
            <a href="/Admin/Promo/Create" class="btn btn-success">
                <i class="bi bi-plus-lg"></i> Thêm khuyến mãi
            </a>
        </div>

        <!-- BẢNG + PHÂN TRANG ĐƯA XUỐNG DƯỚI CÙNG -->
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>STT</th>
                            <th>Mã</th>
                            <th>Mô tả</th>
                            <th>Loại</th>
                            <th>Giá trị</th>
                            <th>Bắt đầu</th>
                            <th>Kết thúc</th>
                            <th>Đã dùng</th>
                            <th>Trạng thái</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="promoTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- PHÂN TRANG + THÔNG TIN KẾT QUẢ – ĐƯA XUỐNG DƯỚI BẢNG -->
            <div class="card-footer bg-transparent border-top-0">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <small class="text-muted">
                        Hiển thị <strong id="resultCount">0</strong> / <strong id="totalCount">0</strong> khuyến mãi
                    </small>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script>
        const url = window.location.origin;
        let allPromos = [];
        let filtered = [];
        const pageSize = 10;
        let currentPage = 1;

        $(document).ready(function () {
            loadPromos();
        });

        function loadPromos() {
            $('#promoTableBody').html('<tr><td colspan="10" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>');
            $.get(url + '/Admin/Promo/GetAllPromos')
                .done(res => {
                    if (res.success && Array.isArray(res.data)) {
                        allPromos = res.data;
                        applyFilters();
                    } else {
                        $('#promoTableBody').html('<tr><td colspan="10" class="text-center text-danger py-4">Không có dữ liệu</td></tr>');
                    }
                })
                .fail(() => {
                    $('#promoTableBody').html('<tr><td colspan="10" class="text-center text-danger py-4">Lỗi server</td></tr>');
                });
        }

        function applyFilters() {
            const search = $('#searchInput').val().trim().toLowerCase();
            const typeFilter = $('#typeFilter').val();
            const statusFilter = $('#statusFilter').val();

            filtered = allPromos.filter(p => {
                const matchSearch = !search ||
                    (p.Code && p.Code.toLowerCase().includes(search)) ||
                    (p.Description && p.Description.toLowerCase().includes(search));

                let matchType = true;
                if (typeFilter) {
                    const rawType = (p.Type || '').toString().toLowerCase().trim();
                    if (typeFilter === 'amount') {
                        matchType = rawType.includes('amount') || rawType === 'fixed' || rawType === 'money' || rawType === '1';
                    } else if (typeFilter === 'percentage') {
                        matchType = rawType.includes('percent') || rawType.includes('%') || rawType === 'rate' || rawType === '2';
                    }
                }

                const matchStatus = statusFilter === "" || p.IsActive.toString() === statusFilter;
                return matchSearch && matchType && matchStatus;
            });

            currentPage = 1;
            renderTable();
        }

        function resetFilters() {
            $('#searchInput').val('');
            $('#typeFilter').val('');
            $('#statusFilter').val('');
            applyFilters();
        }

        function renderTable() {
            const total = filtered.length;
            const pages = Math.max(1, Math.ceil(total / pageSize));
            const start = (currentPage - 1) * pageSize;
            const data = filtered.slice(start, start + pageSize);

            $('#resultCount').text(data.length);
            $('#totalCount').text(total);

            if (total === 0) {
                $('#promoTableBody').html('<tr><td colspan="10" class="text-center py-5 text-muted">Không tìm thấy khuyến mãi nào</td></tr>');
                $('#pagination').html('');
                return;
            }

            let html = '';
            data.forEach((p, i) => {
                const isPercent = ['percentage', 'percent', '%', 'rate', '2'].some(t =>
                    (p.Type || '').toString().toLowerCase().includes(t)
                );
                const typeText = isPercent ? 'Giảm %' : 'Giảm tiền';
                const valueText = isPercent
                    ? p.Value + '%'
                    : new Intl.NumberFormat('vi-VN').format(p.Value) + ' VNĐ';
                const statusBadge = p.IsActive
                    ? '<span class="badge bg-success">Đang hoạt động</span>'
                    : '<span class="badge bg-secondary">Tạm dừng</span>';
                const used = p.UsedCount || 0;
                const limit = p.UsageLimit ?? '∞';

                html += `
                        <tr>
                            <td>${start + i + 1}</td>
                            <td><strong>${p.Code}</strong></td>
                            <td>${p.Description || '-'}</td>
                            <td>${typeText}</td>
                            <td class="fw-bold text-primary">${valueText}</td>
                            <td>${formatDate(p.StartDate)}</td>
                            <td>${formatDate(p.EndDate)}</td>
                            <td>${used} / ${limit}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <a href="/Admin/Promo/Edit/${p.Id}" class="btn btn-warning btn-sm">Sửa</a>
                                <button type="button" class="btn btn-danger btn-sm ms-1" onclick="deletePromo(${p.Id})">Xóa</button>
                            </td>
                        </tr>`;
            });
            $('#promoTableBody').html(html);

            // Phân trang
            let pag = '';
            for (let i = 1; i <= pages; i++) {
                pag += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" onclick="currentPage=${i}; renderTable(); return false;">${i}</a>
                            </li>`;
            }
            $('#pagination').html(pag);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            let date;
            if (typeof dateStr === 'string' && dateStr.includes('/Date(')) {
                const ms = dateStr.match(/\/Date\((-?\d+)\)\//);
                date = ms ? new Date(parseInt(ms[1])) : new Date(dateStr);
            } else {
                date = new Date(dateStr);
            }
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function deletePromo(id) {
            if (confirm('Xóa khuyến mãi này?')) {
                $.post(url + '/Admin/Promo/DeletePromo', { id })
                    .done(r => {
                        if (r.success) {
                            alert('Xóa thành công!');
                            loadPromos();
                        } else alert(r.message || 'Lỗi');
                    });
            }
        }

        // Enter để lọc
        $('#searchInput').on('keypress', e => { if (e.key === 'Enter') applyFilters(); });
        $('#typeFilter, #statusFilter').on('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); applyFilters(); } });
    </script>
}