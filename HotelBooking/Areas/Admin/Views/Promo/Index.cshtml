@{
    ViewBag.Title = "Quản lý Khuyến mãi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6">
                <h3 class="mb-0">Quản lý Khuyến mãi</h3>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="/Admin/Hotel">Admin</a></li>
                    <li class="breadcrumb-item active">Khuyến mãi</li>
                </ol>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-sm-12">
                <a href="/Admin/Promo/Create" class="btn btn-success" style="float:right">+ Thêm khuyến mãi</a>
            </div>

            <div class="col-sm-12 mt-3" id="div_ShowData">
                <table id="tbl_promos" class="table table-bordered table-striped">
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var url_domain = window.location.origin;

        $(document).ready(function () {
            loadPromos();
        });

        function loadPromos() {
            $.ajax({
                type: "GET",
                url: url_domain + '/Admin/Promo/GetAllPromos',
                success: function (response) {
                    if (response.success) {
                        var promos = response.data;
                        var tbl = $("#tbl_promos");
                        var html = "<thead><tr>";
                        html += "<th>STT</th><th>Mã</th><th>Mô tả</th><th>Loại</th>";
                        html += "<th>Giá trị</th><th>Ngày bắt đầu</th><th>Ngày kết thúc</th>";
                        html += "<th>Đã dùng/Giới hạn</th><th>Trạng thái</th><th>Thao tác</th>";
                        html += "</tr></thead><tbody>";

                        for (var i = 0; i < promos.length; i++) {
                            var promo = promos[i];
                            var statusBadge = promo.IsActive
                                ? '<span class="badge bg-success">Active</span>'
                                : '<span class="badge bg-secondary">Inactive</span>';

                            var typeText = promo.Type === 'amount' ? 'Giảm tiền' : 'Giảm %';
                            var valueText = promo.Type === 'amount'
                                ? promo.Value.toLocaleString() + ' VNĐ'
                                : promo.Value + '%';

                            html += "<tr>";
                            html += "<td>" + (i + 1) + "</td>";
                            html += "<td><strong>" + promo.Code + "</strong></td>";
                            html += "<td>" + (promo.Description || '') + "</td>";
                            html += "<td>" + typeText + "</td>";
                            html += "<td>" + valueText + "</td>";
                            html += "<td>" + (promo.StartDate ? formatDate(promo.StartDate) : '-') + "</td>";
                            html += "<td>" + (promo.EndDate ? formatDate(promo.EndDate) : '-') + "</td>";
                            html += "<td>" + promo.UsedCount + " / " + (promo.UsageLimit || '∞') + "</td>";
                            html += "<td>" + statusBadge + "</td>";
                            html += "<td>";
                            html += "<a href='" + url_domain + "/Admin/Promo/Edit/" + promo.Id + "' class='btn btn-sm btn-warning'>Sửa</a> ";
                            html += "<button type='button' class='btn btn-sm btn-danger' onclick='deletePromo(" + promo.Id + ")'>Xóa</button>";
                            html += "</td></tr>";
                        }

                        html += "</tbody>";
                        tbl.html(html);
                    }
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('vi-VN');
        }

        function deletePromo(id) {
            if (confirm("Bạn có chắc chắn muốn xóa khuyến mãi này không?")) {
                $.ajax({
                    type: "POST",
                    url: url_domain + '/Admin/Promo/DeletePromo',
                    data: JSON.stringify({ id: id }),
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            loadPromos();
                        } else {
                            alert(response.message);
                        }
                    }
                });
            }
        }
    </script>
}