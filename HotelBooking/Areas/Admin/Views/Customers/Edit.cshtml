﻿
@{
    ViewBag.Title = "Khách hàng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <h2 class="mb-4">Chỉnh sửa thông tin khách hàng</h2>

    <div class="card">
        <div class="card-body">
            <form id="customerForm">

                <input type="hidden" id="UserId" value="@ViewBag.UserId" />

                <div id="success-message" class="alert alert-success alert-dismissible fade show" style="display:none;" role="alert">
                    <span></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div id="error-message" class="alert alert-danger alert-dismissible fade show" style="display:none;" role="alert">
                    <span></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="FullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="FullName" required />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="Phone" class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="Phone" />
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-warning">Cập nhật</button>

                    <a href="~/Areas/Admin/Views/Customers/Index.cshtml" class="btn btn-secondary">Hủy</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var userId = "@ViewBag.UserId";
        if (!userId || userId === "0") {
            alert("Không tìm thấy ID khách hàng!");
            window.location.href = "/Admin/Customers";
        }

        $(document).ready(function () {
            loadCustomerData();

            $("#customerForm").submit(function (e) {
                e.preventDefault();
                updateCustomer();
            });
        });


        function loadCustomerData() {
            $.ajax({
                type: "GET",
                url: window.location.origin + '/Admin/Customers/GetCustomerById/' + userId,
                dataType: "json",
                success: function (response) {
                    if (response.success) {
                        $("#FullName").val(response.data.Name || response.data.FullName || "");
                        $("#Phone").val(response.data.Phone || "");
                    } else {
                        showError(response.message || "Không tải được dữ liệu khách hàng");
                    }
                },
                error: function () {
                    showError("Lỗi kết nối server");
                }
            });
        }


        function updateCustomer() {
            var data = {
                UserId: userId,
                FullName: $("#FullName").val().trim(),
                Phone: $("#Phone").val().trim()
            };


            if (!data.FullName) {
                showError("Vui lòng nhập họ tên!");
                return;
            }

            $.ajax({
                type: "POST",
                url: window.location.origin + '/Admin/Customers/UpdateCustomer',
                data: data,
                success: function (response) {
                    if (response.success) {
                        showSuccess("Cập nhật khách hàng thành công!");
                        setTimeout(function () {
                            window.location.href = "/Admin/Customers";
                        }, 1500);
                    } else {
                        showError(response.message || "Cập nhật thất bại");
                    }
                },
                error: function () {
                    showError("Lỗi kết nối server");
                }
            });
        }

        function showSuccess(msg) {
            $("#success-message span").text(msg);
            $("#success-message").show();
            $("#error-message").hide();
        }

        function showError(msg) {
            $("#error-message span").text(msg);
            $("#error-message").show();
            $("#success-message").hide();
        }
    </script>
}

