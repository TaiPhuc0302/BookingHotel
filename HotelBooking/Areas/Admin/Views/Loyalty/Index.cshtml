@{
    ViewBag.Title = "Quản lý Loyalty Tiers";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="app-content-header">
    <div class="container-fluid">

        <!-- Tiêu đề -->
        <div class="row mb-4">
            <div class="col-sm-12">
                <h3 class="mb-0">Quản lý Loyalty Tiers</h3>
            </div>
        </div>

        <!-- Bộ lọc -->
        <div class="row g-3 align-items-end mb-3">
            <div class="col-md-5">
                <label class="form-label">Tìm tên tier hoặc ID</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Nhập từ khóa...">
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button onclick="applyFilters()" class="btn btn-primary flex-grow-1">Lọc</button>
                <button onclick="resetFilters()" class="btn btn-outline-secondary">Reset</button>
            </div>
        </div>

        <!-- NÚT THÊM – NHỎ GỌN, CĂN PHẢI, DƯỚI BỘ LỌC -->
        <div class="mb-3 text-end">
            <a href="/Admin/Loyalty/Create" class="btn btn-success">
                + Thêm Loyalty Tier
            </a>
        </div>

        <!-- BẢNG + PHÂN TRANG DƯỚI CÙNG -->
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Tên Tier</th>
                            <th>Giảm giá (%)</th>
                            <th>Multiplier</th>
                            <th>Min Points</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="tierTable">
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- PHÂN TRANG + KẾT QUẢ HIỂN THỊ – ĐƯA XUỐNG DƯỚI BẢNG -->
            <div class="card-footer bg-transparent border-top-0">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <small class="text-muted">
                        Hiển thị <strong id="resultCount">0</strong> / <strong id="totalCount">0</strong> tier
                    </small>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allTiers = [];
        let filtered = [];
        let currentPage = 1;
        const pageSize = 10;

        // Chuyển /Date(1234567890)/ thành Date
        function parseDotNetDate(dateStr) {
            if (!dateStr) return null;
            const match = dateStr.match(/\/Date\((\d+)\)\//);
            return match ? new Date(parseInt(match[1])) : new Date(dateStr);
        }

        function loadTiers() {
            const url = '@Url.Action("GetAllTiers", "Loyalty", new { area = "Admin" })';
            $("#tierTable").html(`
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                    </td>
                </tr>
            `);

            $.get(url)
                .done(res => {
                    if (res.success && Array.isArray(res.data)) {
                        allTiers = res.data;
                        filtered = [...allTiers];
                        currentPage = 1;
                        renderTable();
                    } else {
                        $("#tierTable").html('<tr><td colspan="7" class="text-center text-danger py-4">Không có dữ liệu</td></tr>');
                    }
                })
                .fail(() => {
                    $("#tierTable").html('<tr><td colspan="7" class="text-center text-danger py-4">Lỗi kết nối server</td></tr>');
                });
        }

        function applyFilters() {
            const search = $("#searchInput").val().trim().toLowerCase();
            filtered = allTiers.filter(t =>
                !search ||
                (t.Name && t.Name.toLowerCase().includes(search)) ||
                (t.Id && t.Id.toString().includes(search))
            );
            currentPage = 1;
            renderTable();
        }

        function resetFilters() {
            $("#searchInput").val("");
            filtered = [...allTiers];
            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const total = filtered.length;
            const pages = Math.max(1, Math.ceil(total / pageSize));
            const start = (currentPage - 1) * pageSize;
            const data = filtered.slice(start, start + pageSize);

            $("#resultCount").text(data.length);
            $("#totalCount").text(allTiers.length);

            if (total === 0) {
                $("#tierTable").html('<tr><td colspan="7" class="text-center text-muted py-5">Không tìm thấy tier nào</td></tr>');
                $("#pagination").html('');
                return;
            }

            let html = "";
            data.forEach(t => {
                const created = parseDotNetDate(t.CreatedAt);
                const dateStr = created ? created.toLocaleDateString("vi-VN") : "-";

                html += `
                    <tr id="tier_${t.Id}">
                        <td>${t.Id}</td>
                        <td><strong>${t.Name || '-'}</strong></td>
                        <td class="text-primary fw-bold">${t.DiscountPercent || 0}%</td>
                        <td>${t.Multiplier || 1}x</td>
                        <td>${t.MinPoints?.toLocaleString() || 0}</td>
                        <td>${dateStr}</td>
                        <td>
                            <a href="/Admin/Loyalty/Edit/${t.Id}" class="btn btn-warning btn-sm">Sửa</a>
                            <button class="btn btn-danger btn-sm ms-1" onclick="deleteTier(${t.Id})">Xóa</button>
                        </td>
                    </tr>`;
            });

            $("#tierTable").html(html);

            // Phân trang
            let pag = "";
            for (let i = 1; i <= pages; i++) {
                pag += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="currentPage=${i}; renderTable(); return false;">${i}</a>
                        </li>`;
            }
            $("#pagination").html(pag);
        }

        function deleteTier(id) {
            if (!confirm("Bạn có chắc chắn muốn xóa Loyalty Tier này?")) return;

            const url = '@Url.Action("DeleteTier", "Loyalty", new { area = "Admin" })';
            $.post(url, { id })
                .done(res => {
                    if (res.success) {
                        allTiers = allTiers.filter(x => x.Id !== id);
                        applyFilters();
                        alert("Xóa thành công!");
                    } else {
                        alert(res.message || "Xóa thất bại");
                    }
                })
                .fail(() => alert("Lỗi server"));
        }

        $(document).ready(function () {
            loadTiers();

            $("#searchInput").on("keypress", e => {
                if (e.key === "Enter") applyFilters();
            });
        });
    </script>
}