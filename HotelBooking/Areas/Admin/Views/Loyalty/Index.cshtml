@{
    ViewBag.Title = "Quản lý Loyalty Tiers";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="row">
    <div class="col-sm-6"><h3 class="mb-0">Quản lý Loyalty Tiers</h3></div>
    <div class="col-sm-6 text-end">
        <a href="/Admin/Loyalty/Create" class="btn btn-success">+ Thêm Loyalty Tier</a>
    </div>
</div>

<!-- Filter -->
<div class="row g-3 align-items-end mt-4">
    <div class="col-md-4">
        <label class="form-label">Tìm mã / tên</label>
        <input type="text" id="searchInput" class="form-control" placeholder="Nhập từ khóa...">
    </div>

    <div class="col-md-3 d-flex gap-2">
        <button onclick="applyFilters()" class="btn btn-primary flex-grow-1">Lọc</button>
        <button onclick="resetFilters()" class="btn btn-outline-secondary">Reset</button>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center my-4">
    <small class="text-muted">
        Hiển thị <strong id="resultCount">0</strong> / <strong id="totalCount">0</strong> loyalty
    </small>
    <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
</div>

<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên tier</th>
                    <th>Giảm giá (%)</th>
                    <th>Multiplier</th>
                    <th>MinPoints</th>
                    <th>Ngày tạo</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="tierTable">
                <tr><td colspan="6" class="text-center">Đang tải dữ liệu...</td></tr>
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>

    let allTiers = [];
    let filtered = [];
    let currentPage = 1;
    const pageSize = 10;

    function parseDotNetDate(dotNetDate) {
        if (!dotNetDate) return "";
        var ms = parseInt(dotNetDate.match(/\d+/));
        return new Date(ms);
    }

    // Load toàn bộ tiers
    function loadTiers() {
        let url = '@Url.Action("GetAllTiers", "Loyalty", new { area = "Admin" })';

        $("#tierTable").html(`<tr><td colspan="7" class="text-center py-4">
            <div class="spinner-border text-primary"></div></td></tr>`);

        $.get(url).done(res => {
            if (res.success && Array.isArray(res.data)) {
                allTiers = res.data;
                filtered = allTiers;
                currentPage = 1;
                renderTable();
            } else {
                $("#tierTable").html(`<tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>`);
            }
        }).fail(() => {
            $("#tierTable").html(`<tr><td colspan="7" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>`);
        });
    }

    // Áp dụng tìm kiếm
    function applyFilters() {
        const search = $("#searchInput").val().trim().toLowerCase();

        filtered = allTiers.filter(t =>
            !search ||
            (t.Name && t.Name.toLowerCase().includes(search)) ||
            (t.Id && t.Id.toString().includes(search))
        );

        currentPage = 1;
        renderTable();
    }

    // Reset
    function resetFilters() {
        $("#searchInput").val("");
        filtered = allTiers;
        currentPage = 1;
        renderTable();
    }

    // Render bảng + phân trang
    function renderTable() {
        const total = filtered.length;
        const pages = Math.max(1, Math.ceil(total / pageSize));

        $("#totalCount").text(allTiers.length);
        $("#resultCount").text(total);

        const start = (currentPage - 1) * pageSize;
        const data = filtered.slice(start, start + pageSize);

        let html = "";

        if (data.length === 0) {
            html = `<tr><td colspan="7" class="text-center text-muted py-4">Không có dữ liệu</td></tr>`;
        } else {
            data.forEach(t => {
                let created = parseDotNetDate(t.CreatedAt).toLocaleDateString("vi-VN");

                html += `
                    <tr id="tier_${t.Id}">
                        <td>${t.Id}</td>
                        <td>${t.Name}</td>
                        <td>${t.DiscountPercent}%</td>
                        <td>${t.Multiplier}</td>
                        <td>${t.MinPoints ?? 0}</td>
                        <td>${created}</td>
                        <td>
                            <a href="/Admin/Loyalty/Edit/${t.Id}" class="btn btn-sm btn-primary">Sửa</a>
                            <button class="btn btn-sm btn-danger" onclick="deleteTier(${t.Id})">Xóa</button>
                        </td>
                    </tr>`;
            });
        }

        $("#tierTable").html(html);

        // Render phân trang
        let pag = "";
        for (let i = 1; i <= pages; i++) {
            pag += `
                <li class="page-item ${i === currentPage ? "active" : ""}">
                    <a class="page-link" href="#" onclick="currentPage=${i}; renderTable(); return false;">${i}</a>
                </li>`;
        }

        $("#pagination").html(pag);
    }

    // Xóa tier
    function deleteTier(id) {
        if (!confirm("Bạn có chắc muốn xóa loyalty tier này không?")) return;

        let url = '@Url.Action("DeleteTier", "Loyalty", new { area = "Admin" })';

        $.post(url, { id })
            .done(res => {
                if (res.success) {
                    allTiers = allTiers.filter(x => x.Id !== id);
                    applyFilters();
                    alert("Xóa thành công!");
                } else {
                    alert(res.message);
                }
            })
            .fail(() => alert("Không thể xóa. Lỗi server."));
    }

    // Tự động load khi vào trang
    $(document).ready(function () {
        loadTiers();

        // Tìm kiếm realtime
        $('#searchInput').on('keypress', function (e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    });
    </script>
}


