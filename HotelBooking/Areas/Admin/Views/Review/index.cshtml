@{
    ViewBag.Title = "Quản lý Review";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h2>Quản lý Review</h2>

<div class="form-group">
    <label>Nhập ID khách sạn:</label>
    <input type="number" id="hotelId" class="form-control" placeholder="Nhập HotelId..." />
    <button class="btn btn-primary mt-2" onclick="loadReviews()">Tải Review</button>
</div>

<hr />

<table class="table table-bordered table-striped mt-3">
    <thead>
        <tr>
            <th>ID</th>
            <th>Khách sạn</th>
            <th>Email người dùng</th>
            <th>Rating</th>
            <th>Tiêu đề</th>
            <th>Nội dung</th>
            <th>Ngày tạo</th>
            <th>Hành động</th>
        </tr>
    </thead>
    <tbody id="reviewTable">
        <tr><td colspan="8" class="text-center">Chưa có dữ liệu</td></tr>
    </tbody>
</table>

@section Scripts {
    <script>
        // Hàm parse .NET DateTime /Date(1234567890)/ sang JS Date
        function parseDotNetDate(dotNetDate) {
            var timestamp = parseInt(dotNetDate.replace(/\/Date\((\d+)\)\//, '$1'));
            return new Date(timestamp);
        }

        function loadReviews() {
            var hotelId = document.getElementById("hotelId").value;

            var url = '@Url.Action("GetAllReviews", "Review", new { area = "Admin" })';

            $.ajax({
                url: url,
                type: "GET",
                data: { hotelId: hotelId },
                success: function(response) {
                    if (response.success) {
                        var rows = "";
                        if (response.data.length > 0) {
                            response.data.forEach(function(r) {
                                var createdAt = parseDotNetDate(r.CreatedAt).toLocaleDateString();
                                rows += `
                                    <tr id="reviewRow_${r.Id}">
                                        <td>${r.Id}</td>
                                        <td>${r.HotelName}</td>
                                        <td>${r.UserEmail}</td>
                                        <td>${r.Rating} ⭐</td>
                                        <td>${r.Title || ""}</td>
                                        <td>${r.Content}</td>
                                        <td>${createdAt}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteReview(${r.Id})">Xóa</button>
                                        </td>
                                    </tr>
                                `;
                            });
                        } else {
                            rows = `<tr><td colspan="8" class="text-center">Chưa có dữ liệu</td></tr>`;
                        }
                        $("#reviewTable").html(rows);
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr) {
                    console.log(xhr.responseText);
                    alert("Không thể tải dữ liệu. Lỗi: " + xhr.status);
                }
            });
        }

        function deleteReview(id) {
            if (!confirm("Bạn có chắc muốn xóa đánh giá này không?")) return;

            var url = '@Url.Action("DeleteReview", "Review", new { area = "Admin" })';

            $.ajax({
                url: url,
                type: "POST",
                data: { id: id },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        $("#reviewRow_" + id).remove();
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr) {
                    console.log(xhr.responseText);
                    alert("Xóa thất bại. Lỗi: " + xhr.status);
                }
            });
        }
    </script>
}

