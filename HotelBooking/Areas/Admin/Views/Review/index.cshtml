@{
    ViewBag.Title = "Quản lý Review";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="app-content-header">
    <div class="container-fluid">

        <!-- Tiêu đề -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 class="mb-0">Quản lý Đánh giá (Review)</h3>
            </div>
        </div>

        <!-- Ô tìm kiếm theo HotelId -->
        <div class="row mb-3">
            <div class="col-md-5">
                <label class="form-label">Tìm theo ID khách sạn</label>
                <div class="input-group">
                    <input type="number" id="hotelId" class="form-control" placeholder="Nhập HotelId rồi nhấn Enter..." min="1">
                    <button class="btn btn-outline-secondary" type="button" onclick="loadReviews()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Bảng Review -->
        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Khách sạn</th>
                            <th>Email người dùng</th>
                            <th>Điểm</th>
                            <th>Tiêu đề</th>
                            <th>Nội dung</th>
                            <th>Ngày tạo</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="reviewTable">
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                                <span class="ms-2">Đang tải dữ liệu...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer: thông tin + phân trang -->
            <div class="card-footer bg-transparent border-top-0">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <small class="text-muted">
                        Hiển thị <strong id="resultCount">0</strong> đánh giá
                    </small>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <script>
        let allReviews = [];
        let filtered = [];
        let currentPage = 1;
        const pageSize = 10;

        // Parse ngày .NET
        function parseDotNetDate(dateStr) {
            if (!dateStr) return null;
            const match = dateStr.match(/\/Date\((\d+)\)\//);
            return match ? new Date(parseInt(match[1])) : new Date(dateStr);
        }

        // Format ngày đẹp
        function formatDate(dateStr) {
            const date = parseDotNetDate(dateStr);
            return date ? date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-';
        }

        $(document).ready(function () {
            loadReviews(); // Load tất cả khi vào trang

            // Nhấn Enter trong ô input → tìm
            $("#hotelId").on("keypress", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    loadReviews();
                }
            });
        });

        function loadReviews() {
            const hotelId = $("#hotelId").val().trim();
            const url = '@Url.Action("GetAllReviews", "Review", new { area = "Admin" })';

            $("#reviewTable").html(`
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <div class="spinner-border text-primary"></div>
                        <span class="ms-2">Đang tải...</span>
                    </td>
                </tr>
            `);

            $.get(url, { hotelId: hotelId || null })
                .done(res => {
                    if (res.success && Array.isArray(res.data)) {
                        allReviews = res.data;
                        filtered = [...allReviews];
                        currentPage = 1;
                        renderTable();
                    } else {
                        $("#reviewTable").html('<tr><td colspan="8" class="text-center text-danger py-4">Không có dữ liệu</td></tr>');
                        $("#resultCount").text("0");
                        $("#pagination").html("");
                    }
                })
                .fail(() => {
                    $("#reviewTable").html('<tr><td colspan="8" class="text-center text-danger py-4">Lỗi kết nối server</td></tr>');
                });
        }

        function renderTable() {
            const total = filtered.length;
            const pages = Math.max(1, Math.ceil(total / pageSize));
            const start = (currentPage - 1) * pageSize;
            const data = filtered.slice(start, start + pageSize);

            $("#resultCount").text(total);

            if (total === 0) {
                $("#reviewTable").html('<tr><td colspan="8" class="text-center text-muted py-5">Không tìm thấy đánh giá nào</td></tr>');
                $("#pagination").html("");
                return;
            }

            let html = "";
            data.forEach(r => {
                html += `
                    <tr id="reviewRow_${r.Id}">
                        <td>${r.Id}</td>
                        <td><strong>${r.HotelName || "N/A"}</strong></td>
                        <td>${r.UserEmail || "N/A"}</td>
                        <td><span class="badge bg-warning text-dark">${r.Rating} ⭐</span></td>
                        <td>${r.Title || "<em>(không có)</em>"}</td>
                        <td>${r.Content ? r.Content.substring(0, 80) + (r.Content.length > 80 ? "..." : "") : "-"}</td>
                        <td>${formatDate(r.CreatedAt)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteReview(${r.Id})">
                                <i></i> Xóa
                            </button>
                        </td>
                    </tr>`;
            });

            $("#reviewTable").html(html);

            // Phân trang
            let pag = "";
            for (let i = 1; i <= pages; i++) {
                pag += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="currentPage=${i}; renderTable(); return false;">${i}</a>
                        </li>`;
            }
            $("#pagination").html(pag);
        }

        function deleteReview(id) {
            if (!confirm("Bạn có chắc chắn muốn xóa đánh giá này?")) return;

            const url = '@Url.Action("DeleteReview", "Review", new { area = "Admin" })';
            $.post(url, { id })
                .done(res => {
                    if (res.success) {
                        $(`#reviewRow_${id}`).fadeOut(300, function () { $(this).remove(); });
                        allReviews = allReviews.filter(x => x.Id !== id);
                        renderTable();
                        alert("Xóa thành công!");
                    } else {
                        alert(res.message || "Xóa thất bại");
                    }
                })
                .fail(() => alert("Lỗi server"));
        }
    </script>
}