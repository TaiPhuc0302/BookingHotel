﻿@{
    ViewBag.Title = "Chi tiết khách sạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="hotelDetails"></div>

<div class="mt-4">
    <ul class="nav nav-tabs" id="hotelTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms" type="button">
                Phòng trống
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button">
                Đánh giá
            </button>
        </li>
    </ul>
    <div class="tab-content" id="hotelTabsContent">
        <div class="tab-pane fade show active" id="rooms" role="tabpanel">
            <div id="hotelRooms" class="mt-3"></div>
        </div>
        <div class="tab-pane fade" id="reviews" role="tabpanel">
            <div id="hotelReviews" class="mt-3"></div>
        </div>
    </div>
</div>

@section scripts {
    <script>
    var hotelId = @ViewBag.HotelId;
    var isAuthenticated = '@Request.IsAuthenticated'.toLowerCase() === 'true';

    $(document).ready(function () {
        loadHotelDetails();
        loadHotelRooms();
        loadHotelReviews();
    });

    function loadHotelDetails() {
        $.ajax({
            type: "GET",
            url: window.location.origin + '/Hotel/GetDetails/' + hotelId,
            success: function (response) {
                if (response.success) {
                    var hotel = response.data;
                    var html = '<div class="row">';
                    html += '<div class="col-md-12">';
                    html += '<h2>' + hotel.Name + '</h2>';
                    html += '<p class="h5">' + '⭐'.repeat(hotel.StarRating) + '</p>';
                    html += '<p><i class="fas fa-map-marker-alt"></i> <strong>Địa chỉ:</strong> ' + hotel.Address + ', ' + hotel.City + ', ' + hotel.Country + '</p>';

                    if (hotel.Images && hotel.Images.length > 0) {
                        html += '<div id="hotelCarousel" class="carousel slide mb-4" data-bs-ride="carousel">';
                        html += '<div class="carousel-inner">';
                        hotel.Images.forEach(function(img, index) {
                            html += '<div class="carousel-item ' + (index === 0 ? 'active' : '') + '">';
                            html += '<img src="' + img.Url + '" class="d-block w-100" style="height: 400px; object-fit: cover;" alt="' + img.AltText + '">';
                            html += '</div>';
                        });
                        html += '</div>';
                        html += '<button class="carousel-control-prev" type="button" data-bs-target="#hotelCarousel" data-bs-slide="prev">';
                        html += '<span class="carousel-control-prev-icon"></span></button>';
                        html += '<button class="carousel-control-next" type="button" data-bs-target="#hotelCarousel" data-bs-slide="next">';
                        html += '<span class="carousel-control-next-icon"></span></button>';
                        html += '</div>';
                    }

                    html += '<h4>Mô tả</h4><p>' + (hotel.Description || 'Chưa có mô tả') + '</p>';
                    html += '</div></div>';

                    $("#hotelDetails").html(html);
                }
            }
        });
    }

    function loadHotelRooms() {
        $.ajax({
            type: "GET",
            url: window.location.origin + '/Hotel/GetRooms/' + hotelId,
            success: function (response) {
                if (response.success && response.rooms.length > 0) {
                    var html = '';
                    response.rooms.forEach(function(room) {
                        html += '<div class="card mb-3">';
                        html += '<div class="card-body">';
                        html += '<div class="row">';
                        html += '<div class="col-md-8">';
                        html += '<h5 class="card-title">' + room.Name + '</h5>';
                        html += '<p class="card-text">' + (room.Description || '') + '</p>';
                        html += '<ul class="list-unstyled">';
                        html += '<li><i class="fas fa-users"></i> <strong>Sức chứa:</strong> ' + room.Capacity + ' người</li>';
                        html += '<li><i class="fas fa-bed"></i> <strong>Số phòng còn trống:</strong> ' + room.TotalRooms + '</li>';
                        html += '</ul>';
                        html += '</div>';
                        html += '<div class="col-md-4 text-end">';
                        html += '<p class="h4 text-danger">' + room.PricePerNight.toLocaleString() + ' VNĐ</p>';
                        html += '<p class="text-muted">mỗi đêm</p>';

                        if (isAuthenticated) {
                            html += '<a href="/Customer/Booking/Create?roomId=' + room.Id + '&hotelId=' + hotelId + '" class="btn btn-success btn-lg w-100">Đặt phòng</a>';
                        } else {
                            html += '<a href="/Account/Login" class="btn btn-primary btn-lg w-100">Đăng nhập để đặt</a>';
                        }

                        html += '</div></div></div></div>';
                    });
                    $("#hotelRooms").html(html);
                } else {
                    $("#hotelRooms").html('<div class="alert alert-warning">Hiện tại không có phòng trống</div>');
                }
            }
        });
    }

    function loadHotelReviews() {
        $.ajax({
            type: "GET",
            url: window.location.origin + '/Hotel/GetReviews/' + hotelId,
            success: function (response) {
                if (response.success) {
                    var html = '<div class="card">';
                    html += '<div class="card-body">';

                    if (response.reviews.length > 0) {
                        var avgRating = response.avgRating.toFixed(1);
                        html += '<h5>Đánh giá từ khách hàng</h5>';
                        html += '<div class="alert alert-info">';
                        html += '<p class="h4 mb-0"><strong>' + avgRating + '/5.0</strong> ⭐ (' + response.reviews.length + ' đánh giá)</p>';
                        html += '</div><hr />';

                        response.reviews.slice(0, 10).forEach(function(review) {
                            html += '<div class="mb-4">';
                            html += '<div class="d-flex justify-content-between">';
                            html += '<strong>' + review.UserEmail + '</strong>';
                            html += '<small class="text-muted">' + new Date(review.CreatedAt).toLocaleDateString('vi-VN') + '</small>';
                            html += '</div>';
                            html += '<p class="mb-1">' + '⭐'.repeat(review.Rating) + '</p>';
                            html += '<p>' + review.Content + '</p>';
                            html += '</div>';
                        });

                        if (response.reviews.length > 10) {
                            html += '<p class="text-center text-muted">Và ' + (response.reviews.length - 10) + ' đánh giá khác...</p>';
                        }
                    } else {
                        html += '<p class="text-muted">Chưa có đánh giá nào cho khách sạn này</p>';
                    }

                    html += '</div></div>';
                    $("#hotelReviews").html(html);
                }
            }
        });
    }
    </script>
}

